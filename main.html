<!DOCTYPE html>
<html lang="it">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grafico Previsioni da JSON Google</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f5;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }
        .json-input-container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 1000px;
            box-sizing: border-box;
        }
        .json-input-container textarea {
            width: 100%;
            min-height: 150px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 0.9em;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        .json-input-container button {
            background-color: #1a73e8;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .json-input-container button:hover {
            background-color: #174ea6;
        }
        .chart-display-container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 1000px;
            padding: 20px;
            box-sizing: border-box;
        }

        .tooltip-controls { /* Nuovo wrapper per tooltip e pulsante di copia */
            display: flex;
            align-items: flex-start; 
            gap: 15px; 
            margin-bottom: 20px; 
        }

        .fixed-chart-tooltip {
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 10px;
            /* margin-bottom: 20px; -- rimosso, gestito da tooltip-controls */
            font-size: 0.85em;
            color: #333;
            min-height: 8em;
            display: grid;
            grid-template-columns: auto 1fr auto 1fr;
            gap: 5px 15px;
            align-items: center;
            flex-grow: 1; /* Occupa lo spazio disponibile */
        }
        .fixed-chart-tooltip .label {
            color: #5f6368;
            text-align: right;
        }
        .fixed-chart-tooltip .value {
            font-weight: 500;
            color: #1a73e8;
            text-align: left;
        }
        .fixed-chart-tooltip .placeholder {
            grid-column: 1 / -1;
            text-align: center;
            color: #757575;
            font-style: italic;
            padding: 10px 0;
        }

        #copyTooltipButton { /* Stile per il nuovo pulsante */
            background-color: #28a745; /* Verde */
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, opacity 0.2s;
            height: fit-content; 
            flex-shrink: 0; 
        }
        #copyTooltipButton:hover:not(:disabled) {
            background-color: #218838;
        }
        #copyTooltipButton:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        .error-message {
            color: red;
            font-size: 0.9em;
            margin-top: 10px;
            white-space: pre-wrap;
        }

        #jsonDropdown {
            width: 100%; /* Or a specific max-width like other inputs */
            padding: 10px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            font-family: 'Roboto', sans-serif;
            font-size: 0.9em;
            box-sizing: border-box;
            margin-bottom: 10px; /* If needed for spacing */
            background-color: #fff;
        }

        #aggregatedDataTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px; /* Space between title and table */
        }
        #aggregatedDataTable th, 
        #aggregatedDataTable td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.85em; /* Match fixedChartTooltip font-size */
        }
        #aggregatedDataTable th {
            background-color: #f5f5f5; /* Match body background or a light header color */
            font-weight: 500; /* Similar to other button/label weights */
            color: #333;
        }
        #aggregatedDataTable tbody tr:hover {
            background-color: #f9f9f9; /* Subtle hover for data rows */
        }
        #aggregatedDataTable tfoot td {
            font-weight: bold;
            background-color: #f0f0f0; /* Slightly different for footer */
            border-top: 2px solid #dadce0;
            color: #1a73e8; /* Theme color for summary text */
        }
        /* Style for the first cell in tfoot if it's a label */
        #aggregatedDataTable tfoot td:first-child {
            color: #333; /* Default text color for "Totale/Media Riepilogo:" */
        }
    </style>
</head>
<body>

    <!-- Contenitore per il JSON -->
    <script id="jsonDataContainer" type="application/json" style="display: none;">
{
    "2": [
        "{\"4\":{\"3\":{\"1\":0,\"3\":{\"1\":[{\"1\":16,\"2\":{\"1\":\"campaign_spec.fields\",\"2\":\"AVERAGE_CPA_MICROS field cannot be calculated: Insufficient Conversion Data. Conversion rate is not available.\"}},{\"1\":16,\"2\":{\"1\":\"campaign_spec.fields\",\"2\":\"CONVERSIONS field cannot be calculated: Insufficient Conversion Data. Conversion rate is not available.\"}}]}},\"4\":\"2462873650389287394\"},\"6\":{\"1\":[{\"1\":[{\"1\":2,\"2\":2616715},{\"1\":3,\"2\":1747502},{\"1\":4,\"2\":2100089}],\"2\":\"cost_per_click\"},{\"1\":[{\"1\":2,\"2\":130300.453125},{\"1\":3,\"2\":50128.9375},{\"1\":4,\"2\":3626.253662109375}],\"2\":\"clicks\"},{\"1\":[{\"1\":2,\"2\":0.08532301336526871},{\"1\":3,\"2\":0.04880068823695183},{\"1\":4,\"2\":0.13692666590213776}],\"2\":\"click_through_rate\"},{\"1\":[{\"1\":2,\"2\":339482000000},{\"1\":3,\"2\":87205000000},{\"1\":4,\"2\":7690000000}],\"2\":\"cost_micros\"},{\"1\":[{\"1\":2,\"2\":3978536},{\"1\":3,\"2\":1786966},{\"1\":4,\"2\":56163}],\"2\":\"impressions\"}]},\"3\":\"IT\",\"5\":\"EUR\"}",
        "{\"4\":{\"3\":{\"1\":0,\"3\":{\"1\":[{\"1\":16,\"2\":{\"1\":\"campaign_spec.fields\",\"2\":\"AVERAGE_CPA_MICROS field cannot be calculated: Insufficient Conversion Data. Conversion rate is not available.\"}},{\"1\":16,\"2\":{\"1\":\"campaign_spec.fields\",\"2\":\"CONVERSIONS field cannot be calculated: Insufficient Conversion Data. Conversion rate is not available.\"}}]}},\"4\":\"2462873650389287394\"}",
        "{\"1\":{\"1\":[{\"1\":10000000,\"2\":1000000000000}],\"2\":7},\"2\":1}",
        "{\"1\":1,\"2\":7,\"3\":16000000,\"4\":true}",
        "{\"2\":[{\"3\":\"10111816\",\"200\":{\"1\":[\"1303.00453125\",\"3394820000\",\"39785.36\",\"0\",\"0\"]}},{\"3\":\"10689582\",\"200\":{\"1\":[\"2358.496\",\"5765880000\",\"68822.08\",\"0\",\"0\"]}},{\"3\":\"11267348\",\"200\":{\"1\":[\"3646.2786\",\"8628200000\",\"101202.56\",\"0\",\"0\"]}},{\"3\":\"11845114\",\"200\":{\"1\":[\"5158.0483\",\"12005900000\",\"137115.88\",\"0\",\"0\"]}},{\"3\":\"12422880\",\"200\":{\"1\":[\"6882.0117\",\"15916600000\",\"176728.64\",\"0\",\"0\"]}},{\"3\":\"13000646\",\"200\":{\"1\":[\"8804.265\",\"20372900000\",\"220192.92\",\"0\",\"0\"]}},{\"3\":\"13578412\",\"200\":{\"1\":[\"10909.893\",\"25382900000\",\"267648.84\",\"0\",\"0\"]}},{\"3\":\"14156178\",\"200\":{\"1\":[\"13182.453\",\"30949000000\",\"319222.84\",\"0\",\"0\"]}},{\"3\":\"14733944\",\"200\":{\"1\":[\"15604.828\",\"37068300000\",\"375029.84\",\"0\",\"0\"]}},{\"3\":\"15311710\",\"200\":{\"1\":[\"18158.836\",\"43732300000\",\"435177.64\",\"0\",\"0\"]}},{\"3\":\"15889476\",\"200\":{\"1\":[\"20825.844\",\"50928300000\",\"499760.8\",\"0\",\"0\"]}},{\"3\":\"16000000\",\"200\":{\"1\":[\"21143.59\",\"51799390000\",\"507748.6\",\"0\",\"0\"]}},{\"3\":\"16467242\",\"200\":{\"1\":[\"23586.51\",\"58640100000\",\"568858.08\",\"0\",\"0\"]}},{\"3\":\"17045008\",\"200\":{\"1\":[\"26421.854\",\"66846700000\",\"642539.64\",\"0\",\"0\"]}},{\"3\":\"17622774\",\"200\":{\"1\":[\"29311.803\",\"75522800000\",\"720858.2\",\"0\",\"0\"]}},{\"3\":\"18200540\",\"200\":{\"1\":[\"32237.867\",\"84640200000\",\"803850.6\",\"0\",\"0\"]}},{\"3\":\"18778306\",\"200\":{\"1\":[\"35182.555\",\"94170000000\",\"891548.6\",\"0\",\"0\"]}},{\"3\":\"19356072\",\"200\":{\"1\":[\"38130.477\",\"104081000000\",\"983967.0\",\"0\",\"0\"]}},{\"3\":\"19933838\",\"200\":{\"1\":[\"41068.863\",\"114344000000\",\"1081108.0\",\"0\",\"0\"]}},{\"3\":\"20511604\",\"200\":{\"1\":[\"43987.086\",\"124931000000\",\"1182959.0\",\"0\",\"0\"]}},{\"3\":\"21089370\",\"200\":{\"1\":[\"46876.445\",\"135814000000\",\"1289500.0\",\"0\",\"0\"]}},{\"3\":\"21667136\",\"200\":{\"1\":[\"49730.402\",\"146962000000\",\"1399992.0\",\"0\",\"0\"]}},{\"3\":\"22244902\",\"200\":{\"1\":[\"52543.957\",\"158349000000\",\"1514412.0\",\"0\",\"0\"]}},{\"3\":\"22822668\",\"200\":{\"1\":[\"55313.582\",\"169948000000\",\"1632726.0\",\"0\",\"0\"]}},{\"3\":\"23400434\",\"200\":{\"1\":[\"58036.66\",\"181738000000\",\"1754888.0\",\"0\",\"0\"]}},{\"3\":\"23978200\",\"200\":{\"1\":[\"60711.324\",\"193698000000\",\"1880848.0\",\"0\",\"0\"]}},{\"3\":\"24555966\",\"200\":{\"1\":[\"63336.28\",\"205810000000\",\"2010556.0\",\"0\",\"0\"]}},{\"3\":\"25133732\",\"200\":{\"1\":[\"65909.645\",\"218056000000\",\"2143954.0\",\"0\",\"0\"]}},{\"3\":\"25711498\",\"200\":{\"1\":[\"68430.13\",\"230419000000\",\"2280980.0\",\"0\",\"0\"]}},{\"3\":\"25865045.91\",\"200\":{\"1\":[\"207571.625\",\"944074176080\",\"2991405.0\",\"4965.0146484375\",\"190145295\"]}}],\"3\":{\"2\":[{\"3\":\"clicks\"},{\"3\":\"cost_micros\"},{\"3\":\"impressions\"},{\"3\":\"conversions\"},{\"3\":\"avg_cpa_micros\"}]}}"
    ]
}
    </script> <!-- Fine contenitore JSON -->

    <div class="json-input-container">
        <select id="jsonDropdown"></select>
        <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
            <input type="number" id="manualBudgetInput" placeholder="Inserisci budget..." style="flex-grow: 1; padding: 8px; border: 1px solid #dadce0; border-radius: 4px; font-size: 0.9em;">
            <button id="findBudgetButton" type="button" style="padding: 8px 15px; background-color: #1a73e8; color: white; border: none; border-radius: 4px; font-weight: 500; cursor: pointer;">Trova e Seleziona</button>
        </div>
        <textarea id="jsonInput" placeholder="Il JSON dal tag <script> verrà caricato qui. Puoi modificarlo e ri-cliccare il pulsante." style="display:none;"></textarea>
        <div id="jsonParseError" class="error-message"></div>
    </div>

    <div class="chart-display-container">
        <div class="tooltip-controls">
            <div id="fixedChartTooltipDisplay" class="fixed-chart-tooltip">
                <span class="placeholder">Passa il mouse sul grafico per vedere i dettagli...</span>
            </div>
            <button id="copyTooltipButton" onclick="copyTooltipData()" title="Copia i dati del tooltip in formato tabella (CTRL+C)">Copia Dati</button>
            <button id="addDataButton" type="button">Aggiungi</button>
        </div>
        <div class="chart-container">
            <canvas id="forecastChart"></canvas>
        </div>
    </div>

    <div id="aggregatedDataContainer" style="width: 100%; max-width: 1000px; margin-top: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); padding: 20px; box-sizing: border-box;">
        <h3>Dati Aggiunti:</h3>
        <table id="aggregatedDataTable" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="text-align: left; border-bottom: 1px solid #e0e0e0;">
                    <th style="padding: 8px;">Origine</th> <!-- New header -->
                    <th style="padding: 8px;">Budget</th>
                    <th style="padding: 8px;">Conversioni</th>
                    <th style="padding: 8px;">Costo</th>
                    <th style="padding: 8px;">Clic</th>
                    <th style="padding: 8px;">Impressioni</th>
                    <th style="padding: 8px;">CPA Medio</th>
                    <th style="padding: 8px;">CTR</th>
                    <th style="padding: 8px;">CPC Medio</th>
                    <th style="padding: 8px;">Azioni</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data rows will be added here by JavaScript -->
            </tbody>
            <tfoot>
                <!-- Summary row will be added here by JavaScript -->
            </tfoot>
        </table>
        <div id="aggregatedTableError" class="error-message" style="margin-top: 10px;"></div>
    </div>

    <script>
        const ctx = document.getElementById('forecastChart').getContext('2d');
        const fixedTooltipDisplayEl = document.getElementById('fixedChartTooltipDisplay');
        const jsonParseErrorDiv = document.getElementById('jsonParseError');
        const jsonInputElement = document.getElementById('jsonInput');
        const copyButton = document.getElementById('copyTooltipButton'); // Riferimento al pulsante Copia
        let forecastChart;
        let fullChartDataPoints = [];
        let currentTooltipRawData = null; // Kept for potential hover-only interactions if needed, but selection drives fixed tooltip
        let selectedChartPointData = null;

        const defaultFixedTooltipContent = `<span class="placeholder">Passa il mouse sul grafico per vedere i dettagli o carica i dati...</span>`;

        function updateFixedTooltipUI(pointData) {
            console.log('updateFixedTooltipUI called with pointData:', pointData);
            const addDataButton = document.getElementById('addDataButton'); // Ensure we have the reference
            const copyButton = document.getElementById('copyTooltipButton'); // Ensure we have the reference

            if (!pointData) {
                fixedTooltipDisplayEl.innerHTML = defaultFixedTooltipContent;
                if (copyButton) copyButton.disabled = true;
                if (addDataButton) addDataButton.disabled = true; 
                selectedChartPointData = null; // Safeguard: clear selected data if tooltip is cleared
                console.log('updateFixedTooltipUI: Buttons disabled due to null pointData.');
            } else {
                let innerHtml = `
                    <span class="label">Budget:</span><span class="value">${formatCurrency(pointData.budget)}</span>
                    <span class="label">Conversioni:</span><span class="value">${formatNumber(pointData.conversions)}</span>
                    <span class="label">Costo:</span><span class="value">${formatCurrency(pointData.cost, 'EUR', 2)}</span>
                    <span class="label">Clic:</span><span class="value">${formatNumber(pointData.clicks)}</span>
                    <span class="label">Impressioni:</span><span class="value">${formatNumber(pointData.impressions)}</span>
                    <span class="label">CPA Medio:</span><span class="value">${formatCurrency(pointData.avgCpa, 'EUR', 2)}</span>
                    <span class="label">CTR:</span><span class="value">${formatPercentage(pointData.ctr)}</span>
                    <span class="label">CPC Medio:</span><span class="value">${formatCurrency(pointData.avgCpc, 'EUR', 2)}</span>
                `;
                fixedTooltipDisplayEl.innerHTML = innerHtml;
                // Buttons are explicitly enabled by onClick.
                // If pointData is present but it's only due to hover (not click), onClick handler won't run to enable them.
                // If pointData is present due to a click, onClick handler will enable them.
            }
        }

        function handleAddData() {
            console.log('handleAddData function called.');
            console.log('selectedChartPointData at start of handleAddData:', selectedChartPointData);
            if (!selectedChartPointData) { // Use selectedChartPointData
                alert("Nessun dato selezionato da aggiungere. Clicca su un punto del grafico per selezionare i dati.");
                const addDataButton = document.getElementById('addDataButton');
                if (addDataButton) addDataButton.disabled = true; // Ensure disabled state
                console.log('handleAddData: Guard triggered, returning early.');
                return;
            }
            console.log('handleAddData: Proceeding to add data to table.');

            const jsonDropdown = document.getElementById('jsonDropdown'); // Get dropdown
            const sourceName = jsonDropdown.options[jsonDropdown.selectedIndex].text; // Get selected source name

            const tableBody = document.getElementById('aggregatedDataTable').getElementsByTagName('tbody')[0];
            const newRow = tableBody.insertRow();

            // Add sourceName as the first data item for the row
            const cellsData = [
                sourceName, // New first data item
                formatCurrency(selectedChartPointData.budget),
                formatNumber(selectedChartPointData.conversions),
                formatCurrency(selectedChartPointData.cost, 'EUR', 2),
                formatNumber(selectedChartPointData.clicks),
                formatNumber(selectedChartPointData.impressions),
                formatCurrency(selectedChartPointData.avgCpa, 'EUR', 2),
                formatPercentage(selectedChartPointData.ctr),
                formatCurrency(selectedChartPointData.avgCpc, 'EUR', 2)
            ];

            cellsData.forEach(data => {
                const cell = newRow.insertCell();
                cell.textContent = data;
                cell.style.padding = "8px"; // Match header style
            });

            // Add Delete Button
            const deleteCell = newRow.insertCell();
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Elimina';
            deleteButton.style.backgroundColor = '#dc3545'; // Red color
            deleteButton.style.color = 'white';
            deleteButton.style.border = 'none';
            deleteButton.style.padding = '5px 10px';
            deleteButton.style.borderRadius = '4px';
            deleteButton.style.cursor = 'pointer';
            deleteButton.onclick = function(event) { deleteDataRow(event); }; // Event listener for delete
            deleteButton.onmouseover = function() { 
                this.style.backgroundColor = '#c82333'; // Darker red on hover
            };
            deleteButton.onmouseout = function() { 
                this.style.backgroundColor = '#dc3545';  // Original red
            };
            deleteCell.appendChild(deleteButton);
            deleteCell.style.padding = "8px";

            // Placeholder calls - these functions will be implemented in later steps
            updateSummaryRow(); 
            saveAggregatedData();
            console.log('handleAddData: Row added to table. Calling updateSummaryRow and saveAggregatedData.');
        }

        function findAndSelectBudget() {
            const budgetInput = document.getElementById('manualBudgetInput');
            const budgetToFind = parseFloat(budgetInput.value);

            if (isNaN(budgetToFind)) {
                alert("Per favore, inserisci un valore numerico valido per il budget.");
                return;
            }

            if (!fullChartDataPoints || fullChartDataPoints.length === 0) {
                alert("Nessun dato grafico disponibile per la ricerca. Carica prima i dati.");
                return;
            }

            let closestPoint = null;
            let minDifference = Infinity;

            fullChartDataPoints.forEach(point => {
                const difference = Math.abs(point.budget - budgetToFind);
                if (difference < minDifference) {
                    minDifference = difference;
                    closestPoint = point;
                } else if (difference === minDifference) {
                    // Optional: if two points are equally close, prefer the one with higher conversions or handle as needed.
                    // For now, keeps the first one found with that minimal difference.
                    // Or, prefer the one with budget >= input if multiple are equally close.
                    // Example: if budgetToFind is 100, and points are 90 and 110 (both diff 10),
                    // we might prefer 110. For now, it's the first one encountered.
                }
            });

            if (closestPoint) {
                selectedChartPointData = closestPoint;
                updateFixedTooltipUI(selectedChartPointData); // Update display

                // Enable action buttons
                const copyBtn = document.getElementById('copyTooltipButton');
                const addBtn = document.getElementById('addDataButton');
                if (copyBtn && copyBtn.textContent !== 'Copiato!') copyBtn.disabled = false;
                if (addBtn) addBtn.disabled = false;

                // Optional: Highlight point on chart (advanced)
                // forecastChart.setActiveElements([{ datasetIndex: 0, index: fullChartDataPoints.indexOf(closestPoint) }]);
                // forecastChart.update(); 
                // This setActiveElements might need to be within the chart's own event handling or require more specific API usage.
                // For now, just selecting the data and updating tooltip is the core requirement.

                console.log("Punto più vicino selezionato:", selectedChartPointData);
            } else {
                alert("Nessun punto dati trovato."); // Should not happen if fullChartDataPoints is not empty
            }
        }

        const availableJsonFiles = [
            { name: "Automation 1", filePath: "Automation-1.json" },
            { name: "Automation 2", filePath: "Automation-2.json" },
            { name: "Automation 3", filePath: "Automation-3.json" }
        ];

        async function loadSelectedJsonData() {
            // Reset states when a new JSON is loaded
            selectedChartPointData = null;
            currentTooltipRawData = null;
            updateFixedTooltipUI(null); // Clears fixed display and disables buttons
            console.log('loadSelectedJsonData: Selection and hover data cleared, buttons disabled.');

            const jsonDropdown = document.getElementById('jsonDropdown'); // Get dropdown inside function to ensure it's available
            const selectedFilePath = jsonDropdown.value;
            if (!selectedFilePath) {
                displayJsonParseError("Nessun file JSON selezionato."); // This already handles button disabling via initializeChart
                return;
            }

            try {
                const response = await fetch(selectedFilePath);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} while fetching ${selectedFilePath}`);
                }
                const jsonString = await response.text();
                
                if (jsonInputElement) {
                    jsonInputElement.value = jsonString; 
                    updateUIFromPastedJSON(); 
                } else {
                    console.error("jsonInputElement (textarea) non trovato.");
                    displayJsonParseError("Errore interno: jsonInputElement non trovato.");
                }
            } catch (error) {
                console.error('Errore durante il caricamento o parsing del JSON:', error);
                displayJsonParseError(`Errore caricamento ${selectedFilePath}: ${error.message}`);
            }
        }

        function safeParseFloat(valueStr) {
            if (valueStr === "" || valueStr === null || valueStr === undefined) return 0;
            const cleanedStr = String(valueStr).replace(/[^\d.-]/g, '');
            const num = parseFloat(cleanedStr);
            return isNaN(num) ? 0 : num;
        }

        function formatCurrency(value, currency = 'EUR', decimalPlaces = 0) {
            if (isNaN(value) || value === null || value === undefined) return 'N/D';
            return value.toLocaleString('it-IT', {
                style: 'currency',
                currency: currency,
                minimumFractionDigits: decimalPlaces,
                maximumFractionDigits: decimalPlaces
            });
        }

        function formatNumber(value, decimals = 0) {
            if (isNaN(value)) return 'N/D';
            const roundedValue = Math.round(value); 
            return roundedValue.toLocaleString('it-IT', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }

        function formatPercentage(value, decimals = 2) {
            if (isNaN(value)) return 'N/D';
            const percentage = value * 100;
            const factor = Math.pow(10, decimals);
            const roundedPercentage = Math.round(percentage * factor) / factor;
            return roundedPercentage.toLocaleString('it-IT', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }) + '%';
        }

        function parseFormattedValue(formattedString) {
            if (typeof formattedString !== 'string') {
                return 0;
            }
            let cleanedString = formattedString.replace(/[€%\s]/g, ''); // Remove currency, percentage, spaces
            cleanedString = cleanedString.replace(/\./g, ''); // Remove thousands separators (dots for it-IT)
            cleanedString = cleanedString.replace(/,/g, '.');   // Replace decimal comma with period

            const num = parseFloat(cleanedString);
            
            // If original string had '%', it was a percentage, so divide by 100
            if (formattedString.includes('%')) {
                return isNaN(num) ? 0 : num / 100;
            }
            return isNaN(num) ? 0 : num;
        }

        function deleteDataRow(event) {
            const button = event.target;
            const row = button.closest('tr'); // Get the closest parent <tr>
            if (row) {
                row.remove();
                updateSummaryRow();
                saveAggregatedData(); // Placeholder, will be implemented later
            }
        }

        function updateSummaryRow() {
            const table = document.getElementById('aggregatedDataTable');
            const tbody = table.getElementsByTagName('tbody')[0];
            let tfoot = table.getElementsByTagName('tfoot')[0];

            // Clear existing footer content
            if (tfoot) {
                tfoot.innerHTML = '';
            } else {
                // Create tfoot if it doesn't exist (should not happen with current HTML)
                tfoot = document.createElement('tfoot');
                table.appendChild(tfoot);
            }

            const rowCount = tbody.rows.length;
            if (rowCount === 0) {
                const summaryRow = tfoot.insertRow();
                const cell = summaryRow.insertCell();
                cell.colSpan = 10; // Adjusted for the new "Origine" column
                cell.textContent = 'Nessun dato aggiunto.';
                cell.style.textAlign = 'center';
                cell.style.padding = '8px';
                return;
            }

            // Initialize sums and counts for averages
            // Indices: 0:Budget, 1:Conversioni, 2:Costo, 3:Clic, 4:Impressioni
            // We don't sum pre-calculated averages like CPA, CTR, CPC directly from rows.
            // We calculate them based on the total sums of their components.
            let sums = [0, 0, 0, 0, 0]; // Budget, Conversioni, Costo, Clic, Impressioni

            for (let i = 0; i < rowCount; i++) {
                const row = tbody.rows[i];
                // Assuming "Origine" is at row.cells[0], data starts from row.cells[1]
                sums[0] += parseFormattedValue(row.cells[1].textContent); // Budget
                sums[1] += parseFormattedValue(row.cells[2].textContent); // Conversioni
                sums[2] += parseFormattedValue(row.cells[3].textContent); // Costo
                sums[3] += parseFormattedValue(row.cells[4].textContent); // Clic
                sums[4] += parseFormattedValue(row.cells[5].textContent); // Impressioni
                // CPA, CTR, CPC in row.cells[6,7,8] are not summed up directly for total average
            }

            const summaryRow = tfoot.insertRow();
            summaryRow.style.fontWeight = 'bold';

            // 1. Label "TOTALI / MEDIE:" in the "Origine" column slot
            let summaryCell = summaryRow.insertCell();
            summaryCell.textContent = 'TOTALI / MEDIE:';
            summaryCell.style.padding = '8px';
            summaryCell.style.textAlign = 'left';

            // 2. Total Budget (sums[0])
            summaryCell = summaryRow.insertCell();
            summaryCell.textContent = formatCurrency(sums[0]);
            summaryCell.style.padding = '8px';
            
            // 3. Total Conversioni (sums[1])
            summaryCell = summaryRow.insertCell();
            summaryCell.textContent = formatNumber(sums[1]);
            summaryCell.style.padding = '8px';
            
            // 4. Total Costo (sums[2])
            summaryCell = summaryRow.insertCell();
            summaryCell.textContent = formatCurrency(sums[2], 'EUR', 2);
            summaryCell.style.padding = '8px';

            // 5. Total Clic (sums[3])
            summaryCell = summaryRow.insertCell();
            summaryCell.textContent = formatNumber(sums[3]);
            summaryCell.style.padding = '8px';

            // 6. Total Impressioni (sums[4])
            summaryCell = summaryRow.insertCell();
            summaryCell.textContent = formatNumber(sums[4]);
            summaryCell.style.padding = '8px';
            
            // 7. Average CPA Medio (Total Cost / Total Conversions)
            summaryCell = summaryRow.insertCell();
            summaryCell.textContent = sums[1] > 0 ? formatCurrency(sums[2] / sums[1], 'EUR', 2) : 'N/D';
            summaryCell.style.padding = '8px';

            // 8. Average CTR (Total Clicks / Total Impressions)
            summaryCell = summaryRow.insertCell();
            summaryCell.textContent = sums[4] > 0 ? formatPercentage(sums[3] / sums[4]) : 'N/D';
            summaryCell.style.padding = '8px';
            
            // 9. Average CPC Medio (Total Cost / Total Clicks)
            summaryCell = summaryRow.insertCell();
            summaryCell.textContent = sums[3] > 0 ? formatCurrency(sums[2] / sums[3], 'EUR', 2) : 'N/D';
            summaryCell.style.padding = '8px';

            // 10. Empty cell for "Azioni" column
            summaryCell = summaryRow.insertCell();
            summaryCell.style.padding = '8px';
        }

        function saveAggregatedData() {
            const tableBody = document.getElementById('aggregatedDataTable').getElementsByTagName('tbody')[0];
            const rows = tableBody.rows;
            const dataToSave = [];

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const rowData = {
                    sourceName: row.cells[0].textContent, // Save source name
                    budget: parseFormattedValue(row.cells[1].textContent),    // Index shifted by 1
                    conversions: parseFormattedValue(row.cells[2].textContent), // Index shifted
                    cost: parseFormattedValue(row.cells[3].textContent),       // Index shifted
                    clicks: parseFormattedValue(row.cells[4].textContent),      // Index shifted
                    impressions: parseFormattedValue(row.cells[5].textContent), // Index shifted
                    avgCpa: parseFormattedValue(row.cells[6].textContent),     // Index shifted
                    ctr: parseFormattedValue(row.cells[7].textContent),        // Index shifted
                    avgCpc: parseFormattedValue(row.cells[8].textContent)      // Index shifted
                };
                dataToSave.push(rowData);
            }

            localStorage.setItem('aggregatedTableData', JSON.stringify(dataToSave));
        }

        function _repopulateTableRow(rowData) {
            const tableBody = document.getElementById('aggregatedDataTable').getElementsByTagName('tbody')[0];
            const newRow = tableBody.insertRow();

            const cellsData = [
                rowData.sourceName, // Use sourceName from rowData
                formatCurrency(rowData.budget),
                formatNumber(rowData.conversions),
                formatCurrency(rowData.cost, 'EUR', 2),
                formatNumber(rowData.clicks),
                formatNumber(rowData.impressions),
                formatCurrency(rowData.avgCpa, 'EUR', 2),
                formatPercentage(rowData.ctr),
                formatCurrency(rowData.avgCpc, 'EUR', 2)
            ];

            cellsData.forEach(data => {
                const cell = newRow.insertCell();
                cell.textContent = data;
                cell.style.padding = "8px";
            });

            const deleteCell = newRow.insertCell();
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Elimina';
            deleteButton.style.backgroundColor = '#dc3545';
            deleteButton.style.color = 'white';
            deleteButton.style.border = 'none';
            deleteButton.style.padding = '5px 10px';
            deleteButton.style.borderRadius = '4px';
            deleteButton.style.cursor = 'pointer';
            deleteButton.onclick = function(event) { deleteDataRow(event); };
            deleteButton.onmouseover = function() { 
                this.style.backgroundColor = '#c82333'; // Darker red on hover
            };
            deleteButton.onmouseout = function() { 
                this.style.backgroundColor = '#dc3545';  // Original red
            };
            deleteCell.appendChild(deleteButton);
            deleteCell.style.padding = "8px";
       }

       function loadAggregatedData() {
           const savedDataString = localStorage.getItem('aggregatedTableData');
           if (savedDataString) {
               try {
                   const savedData = JSON.parse(savedDataString);
                   if (Array.isArray(savedData)) {
                       savedData.forEach(rowData => {
                           _repopulateTableRow(rowData); // Use helper to create row from raw data
                       });
                       updateSummaryRow(); // Update summary after loading all rows
                   }
               } catch (error) {
                   console.error("Errore durante il parsing dei dati da localStorage:", error);
                   // Optionally clear corrupted data: localStorage.removeItem('aggregatedTableData');
               }
           }
       }
        
        function copyTooltipData() {
            console.log('copyTooltipData function called.');
            console.log('selectedChartPointData at start of copyTooltipData:', selectedChartPointData);
            // Primary guard: only proceed if a point has been clicked and its data is in selectedChartPointData.
            // The placeholder check is also good as an additional safeguard for UI state.
            if (!selectedChartPointData || fixedTooltipDisplayEl.querySelector('.placeholder')) {
                console.warn("Tentativo di copia: Nessun dato selezionato tramite click o placeholder attivo.");
                // Ensure button is disabled if this state is somehow reached
                if (copyButton) copyButton.disabled = true;
                console.log('copyTooltipData: Guard triggered, returning early.');
                return; 
            }
            console.log('copyTooltipData: Proceeding with copy operation.');
            // Data source is now definitively selectedChartPointData
            const rawData = selectedChartPointData;

            const labels = [
                "Budget", "Conversioni", "Costo", "Clic", 
                "Impressioni", "CPA Medio", "CTR", "CPC Medio"
            ];

            // Use the existing formatting functions which handle it-IT locale and units
            const formattedValues = [
                formatCurrency(rawData.budget),
                formatNumber(rawData.conversions),
                formatCurrency(rawData.cost, 'EUR', 2),
                formatNumber(rawData.clicks),
                formatNumber(rawData.impressions),
                formatCurrency(rawData.avgCpa, 'EUR', 2),
                formatPercentage(rawData.ctr), // This already produces "X,XX%"
                formatCurrency(rawData.avgCpc, 'EUR', 2)
            ];

            // Construct the first row (labels), quoted and tab-separated
            let tableString = labels.map(label => `"${label}"`).join("\t") + "\n";

            // Construct the second row (formatted values), quoted and tab-separated
            tableString += formattedValues.map(value => `"${value}"`).join("\t");

            console.log('copyTooltipData: Attempting to write to clipboard. Transposed tableString:', tableString);

            navigator.clipboard.writeText(tableString) // No .trim() if no trailing newline by default
                .then(() => {
                    console.log('copyTooltipData: Clipboard writeText successful (transposed).');
                    const originalText = copyButton.textContent;
                    copyButton.textContent = 'Copiato!';
                    copyButton.disabled = true;
                    setTimeout(() => {
                        copyButton.textContent = originalText;
                        if (selectedChartPointData && !fixedTooltipDisplayEl.querySelector('.placeholder')) {
                           copyButton.disabled = false;
                        }
                    }, 1500);
                })
                .catch(err => {
                    console.error('Errore durante la copia negli appunti (transposed):', err);
                    console.log('copyTooltipData: Clipboard writeText failed (transposed). Error object:', err);
                    alert('Errore durante la copia. Assicurati che la pagina sia servita tramite HTTPS o localhost e che il browser abbia i permessi.');
                });
        }


        function initializeChart(labels, dataForYAxis, xAxisLabel, yAxisLabel, datasetLabel) {
            if (forecastChart) { forecastChart.destroy(); }
             const numericData = dataForYAxis.map(d => {
                const val = typeof d === 'string' ? safeParseFloat(d) : d;
                return isNaN(val) ? 0 : Math.round(val);
            });

            fixedTooltipDisplayEl.innerHTML = defaultFixedTooltipContent;
            if (copyButton) copyButton.disabled = true;
            const addDataButton = document.getElementById('addDataButton'); // Get ref for state management
            if (addDataButton) addDataButton.disabled = true;


            forecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: datasetLabel || 'Dati', data: numericData,
                        borderColor: '#4285f4', backgroundColor: 'rgba(66, 133, 244, 0.1)',
                        tension: 0.3, fill: true, pointRadius: numericData.length > 1 ? 3 : 5, pointBackgroundColor: '#fff',
                        pointBorderColor: '#4285f4', pointHoverRadius: 7, pointHoverBackgroundColor: '#4285f4', pointHoverBorderColor: '#fff',
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false, axis: 'x' },
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            enabled: false,
                            external: function(context) {
                                // This external tooltip is now primarily for hover effects or direct Chart.js tooltip styling.
                                // The fixed display (fixedChartTooltipDisplayEl) is updated by updateFixedTooltipUI,
                                // which is called by onClick and potentially onHover if no point is selected.
                                const tooltipModel = context.tooltip;
                                if (tooltipModel.opacity === 0 || !tooltipModel.dataPoints || tooltipModel.dataPoints.length === 0) {
                                    currentTooltipRawData = null; // Clear hover data
                                    // If no point is actively selected by click, then onHover can clear the fixed display.
                                    if (!selectedChartPointData) { 
                                        updateFixedTooltipUI(null);
                                    }
                                    return;
                                }
                                const activePointIndex = tooltipModel.dataPoints[0].dataIndex;
                                currentTooltipRawData = fullChartDataPoints[activePointIndex]; // Store hover data

                                // If no point is actively selected by click, update the fixed display on hover.
                                if (!selectedChartPointData && currentTooltipRawData) {
                                    updateFixedTooltipUI(currentTooltipRawData);
                                }
                                // The actual display of fixedChartTooltipDisplayEl is now managed by updateFixedTooltipUI.
                                // Button states (copy/add) are managed by onClick.
                            }
                        }
                    },
                    onClick: function(event, elements) {
                        console.log('Chart onClick triggered. elements:', elements);
                        const addDataButton = document.getElementById('addDataButton'); // Ensure ref
                        if (elements.length > 0) {
                            const firstElement = elements[0];
                            const activePointIndex = firstElement.index;
                            const pointData = fullChartDataPoints[activePointIndex];
                            console.log('Clicked point index:', activePointIndex, 'Raw pointData:', pointData);

                            if (pointData) {
                                selectedChartPointData = pointData; 
                                console.log('selectedChartPointData set to:', selectedChartPointData);
                                updateFixedTooltipUI(selectedChartPointData); 

                                console.log('Enabling copyButton. Current textContent:', copyButton ? copyButton.textContent : 'N/A');
                                if (copyButton && copyButton.textContent !== 'Copiato!') copyButton.disabled = false;
                                console.log('Enabling addDataButton.');
                                if (addDataButton) addDataButton.disabled = false;
                            } else {
                                console.log('Disabling buttons because no valid point was clicked or pointData is invalid.');
                                selectedChartPointData = null;
                                updateFixedTooltipUI(null); 
                                if (copyButton) copyButton.disabled = true;
                                if (addDataButton) addDataButton.disabled = true;
                            }
                        } else {
                            console.log('Disabling buttons because no valid point was clicked or pointData is invalid.');
                            selectedChartPointData = null;
                            updateFixedTooltipUI(null); 
                            if (copyButton) copyButton.disabled = true;
                            if (addDataButton) addDataButton.disabled = true;
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: xAxisLabel || 'Asse X' }, grid: { display: false } },
                        y: {
                            title: { display: true, text: yAxisLabel || 'Asse Y' }, beginAtZero: true,
                            ticks: { callback: v => (v >= 1000000 ? (Math.round(v/1000000 * 10)/10).toLocaleString('it-IT')+'M' : (v >= 1000 ? formatNumber(v/1000)+'K' : formatNumber(v))) }
                        }
                    },
                    onHover: (event, chartElement) => {
                        // const addDataButton = document.getElementById('addDataButton'); // Already available globally or via updateFixedTooltipUI
                        // const copyButton = document.getElementById('copyTooltipButton'); // Already available globally or via updateFixedTooltipUI

                        if (chartElement.length === 0) { // Not hovering over a point
                            currentTooltipRawData = null;
                            if (!selectedChartPointData) { // If nothing is selected by click, clear the fixed display
                                updateFixedTooltipUI(null); 
                            }
                        } else { // Hovering over a point
                            const activePointIndex = chartElement[0].index;
                            currentTooltipRawData = fullChartDataPoints[activePointIndex]; // Update hover data
                            // If no point is actively selected by click, then onHover can update the fixed display.
                            // updateFixedTooltipUI will ensure buttons remain disabled in this hover-only scenario.
                            if (!selectedChartPointData && currentTooltipRawData) { 
                                updateFixedTooltipUI(currentTooltipRawData);
                            }
                        }
                    }
                }
            });
        }
        
        function displayJsonParseError(message) {
            jsonParseErrorDiv.textContent = message;
            console.error(message);
            initializeChart(
                ['N/D'], [0],
                'Budget giornaliero medio (€)', 
                'Conversioni (Errore)',
                'Errore Dati'
            );
            fixedTooltipDisplayEl.innerHTML = `<span class="placeholder">${message}</span>`;
            if (copyButton) copyButton.disabled = true;
            const addDataButton = document.getElementById('addDataButton');
            if (addDataButton) addDataButton.disabled = true;
        }
        
        function loadJsonFromTagToTextarea() {
            const jsonDataElement = document.getElementById('jsonDataContainer');
            if (jsonDataElement) {
                const jsonContent = jsonDataElement.textContent.trim();
                if (jsonInputElement) {
                    jsonInputElement.value = jsonContent;
                }
            }
        }

        function updateUIFromPastedJSON() {
            const jsonString = jsonInputElement.value; 
            jsonParseErrorDiv.textContent = ''; 

            if (!jsonString) {
                displayJsonParseError("Per favore, incolla il JSON nell'area di testo o assicurati che sia caricato dal tag script.");
                return;
            }

            try {
                const rawDataObject = JSON.parse(jsonString); 

                if (!rawDataObject || !rawDataObject["2"] || !Array.isArray(rawDataObject["2"]) || rawDataObject["2"].length < 5) {
                    displayJsonParseError("Il JSON incollato non ha la struttura attesa (proprietà '2' come array con almeno 5 elementi stringa).");
                    return;
                }
                
                const chartDataString = rawDataObject["2"][4]; 
                const parsedChartDataContainer = JSON.parse(chartDataString); 

                const IDX_CLICKS = 0;
                const IDX_COST_MICROS = 1;
                const IDX_IMPRESSIONS = 2;
                const IDX_CONVERSIONS = 3;
                const IDX_AVG_CPA_MICROS = 4;

                fullChartDataPoints = [];

                if (parsedChartDataContainer && parsedChartDataContainer["2"] && Array.isArray(parsedChartDataContainer["2"])) {
                    parsedChartDataContainer["2"].forEach(point => {
                        const budgetMicros = safeParseFloat(point["3"]);
                        const budget = Math.round(budgetMicros / 1000000);

                        let pointMetrics = {
                            budget: budget,
                            clicks: 0, cost: 0, impressions: 0, conversions: 0, avgCpa: 0, ctr: 0, avgCpc: 0
                        };

                        if (point["200"] && point["200"]["1"] && Array.isArray(point["200"]["1"])) {
                            const p200_1 = point["200"]["1"];
                            pointMetrics.clicks = Math.round(safeParseFloat(p200_1[IDX_CLICKS]));
                            const costMicros = safeParseFloat(p200_1[IDX_COST_MICROS]);
                            pointMetrics.cost = costMicros / 1000000; 
                            pointMetrics.impressions = Math.round(safeParseFloat(p200_1[IDX_IMPRESSIONS]));
                            pointMetrics.conversions = Math.round(safeParseFloat(p200_1[IDX_CONVERSIONS]));
                            const avgCpaMicros = safeParseFloat(p200_1[IDX_AVG_CPA_MICROS]);
                            pointMetrics.avgCpa = avgCpaMicros / 1000000; 

                            pointMetrics.ctr = (pointMetrics.impressions > 0) ? (pointMetrics.clicks / pointMetrics.impressions) : 0;
                            pointMetrics.avgCpc = (pointMetrics.clicks > 0 && pointMetrics.cost > 0) ? (pointMetrics.cost / pointMetrics.clicks) : 0;
                        } else {
                            console.warn(`Struttura dati p[200][1] inattesa per budget ${budget}:`, point["200"]);
                        }
                        fullChartDataPoints.push(pointMetrics);
                    });
                } else {
                     displayJsonParseError("Dati specifici per il grafico (JSON all'indice 4 -> sotto-elemento '2') non trovati o in formato non valido.");
                     return; // Assicura che copyButton sia gestito se displayJsonParseError lo fa
                }

                if (fullChartDataPoints.length > 0) {
                    const uniqueBudgetPoints = [];
                    const seenBudgets = new Set();
                    for (const point of fullChartDataPoints) {
                        const budgetKey = point.budget;
                        if (!seenBudgets.has(budgetKey)) {
                            uniqueBudgetPoints.push(point);
                            seenBudgets.add(budgetKey);
                        }
                    }
                    uniqueBudgetPoints.sort((a, b) => a.budget - b.budget);
                    fullChartDataPoints = uniqueBudgetPoints;

                    const chartLabels = fullChartDataPoints.map(p => formatCurrency(p.budget));
                    const chartValuesForYAxis = fullChartDataPoints.map(p => p.conversions);

                    initializeChart(chartLabels, chartValuesForYAxis, 'Budget giornaliero (€)', 'Conversioni', 'Previsione Conversioni');
                } else {
                    initializeChart( // Chiamata a initializeChart gestirà copyButton.disabled
                        [formatCurrency(0)], [0],
                        'Budget giornaliero (€)',
                        'Conversioni (Nessun dato valido per il grafico)',
                        'Previsione Conversioni'
                    );
                     fixedTooltipDisplayEl.innerHTML = `<span class="placeholder">Nessun punto dati valido trovato per il grafico.</span>`;
                     if (copyButton) copyButton.disabled = true; // Doppia sicurezza, ma initializeChart dovrebbe già farlo.
                }

            } catch (error) {
                displayJsonParseError("Errore durante l'analisi del JSON: " + error.message + ". Controlla la console per dettagli e assicurati che il JSON incollato sia valido.");
                console.error("Errore parsing JSON:", error, "Stringa JSON problematica:", jsonString);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const jsonDropdown = document.getElementById('jsonDropdown');
            const addDataButton = document.getElementById('addDataButton');
            console.log('Add Data button found:', addDataButton ? 'Yes' : 'No');

            const copyButton = document.getElementById('copyTooltipButton'); // Already defined globally, but good to have ref here if needed
            console.log('Copy button found:', copyButton ? 'Yes' : 'No');

            const findBudgetButton = document.getElementById('findBudgetButton');
            console.log('Find Budget button found:', findBudgetButton ? 'Yes' : 'No');


            availableJsonFiles.forEach(item => {
                const option = document.createElement('option');
                option.value = item.filePath;
                option.textContent = item.name;
                jsonDropdown.appendChild(option);
            });

            jsonDropdown.addEventListener('change', loadSelectedJsonData);
            if (addDataButton) {
                addDataButton.disabled = true;
                addDataButton.addEventListener('click', handleAddData);
                console.log('Event listener for addDataButton attached.');
            }

            if (findBudgetButton) {
                findBudgetButton.addEventListener('click', findAndSelectBudget);
                console.log('Event listener for findBudgetButton attached.');
            }

            if (copyButton) copyButton.disabled = true; 
            initializeChart( 
                [], [],
                'Budget giornaliero medio (€)', 'Conversioni', 'Previsione Conversioni (Carica i dati)'
            );

            if (availableJsonFiles.length > 0) {
                jsonDropdown.value = availableJsonFiles[0].filePath; 
                loadSelectedJsonData(); 
            } else {
                displayJsonParseError("Nessun file JSON di automazione configurato.");
            }
            
            loadAggregatedData(); // Load saved table data after other initializations
        });
    </script>
</body>
</html>
